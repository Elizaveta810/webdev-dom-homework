<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comments"></ul>
      <div class="add-form" id="add-form">
        <input
          id="add-form-name"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="add-form-text"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button empty" id="add-form-button" disabled>
            Написать
          </button>
        </div>
      </div>
    </div>
  </body>

  <script>
    //Объявляем переменные
    const commentsElement = document.getElementById("comments");
    const addFormButtonElement = document.getElementById("add-form-button");
    const nameInputElement = document.getElementById("add-form-name");
    const textInputElement = document.getElementById("add-form-text");
    const form = document.getElementById("add-form");
    const listElement = document.getElementById("comments");
    let urlApi = "https://wedev-api.sky.pro/api/v1/zudina/comments";

    //Дата
    const formatDateTime = (date) => {
    let dateTime = new Date(date);
    const day = String(dateTime.getDate()).padStart(2, '0');
    const month = String(dateTime.getMonth()).padStart(2, '0');
    const year = String(dateTime.getFullYear() - 2000);
    const minutes = String(dateTime.getMinutes()).padStart(2, '0');
    const hours = String(dateTime.getHours()).padStart(2, '0');
    return `${day}.${month}.${year} ${hours}:${minutes}`;
  };

    //Получаем comments из хранилища комента через API (метод GET)
    function getComments() {
      let fetchPromise = fetch(urlApi, {
        method: "GET",
      }).then((response) => {
          return response.json();
        }).then((responseData) => {
          comments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              date: formatDateTime(comment.date), 
              id: comment.id,
              isLiked: comment.isLiked,
              likes: comment.likes,
              text: comment.text,
            };
          });
          console.log(comments);
          renderComment();
        });
    };

    getComments();




    //Массив обьектов
    let comments = [
      /*{
          name: "Глеб Фокин",
          date: "12.02.22 12:18",
          text: "Это будет первый комментарий на этой странице",
          likeCounter: 3,
          isLiked: true,
        },

        {
          name: "Варвара Н.",
          date: "13.02.22 19:22",
          text: "Мне нравится как оформлена эта страница! ❤",
          likeCounter: 75,
          isLiked: false,
        },*/
    ];

    //Рендер коментария

    const renderComment = () => {
      const commentHtml = comments
        .map((comment, index) => {
          return `<li class="comment" data-index="${index}">
      <div class="comment-header">
        <div>${comment.name}</div>
          <div>${comment.date}</div>
      </div>
        <div class="comment-body">
          <div class="comment-text">
            ${comment.text}
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">${comment.likes}</span>
            <button class="like-button ${
              comment.isLiked ? "-active-like" : ""
            }" data-index="${index}"></button>
          </div>
        </div>
    </li>`;
        })
        .join("");

      listElement.innerHTML = commentHtml;
      initLikeListeners();
      initCommentListeners();
    };
    //Счетчик лайков
    const initLikeListeners = () => {
      const likeButtons = document.querySelectorAll(".like-button");
      for (const likeButton of likeButtons) {
        likeButton.addEventListener("click", (event) => {
          event.stopPropagation();
          const index = likeButton.dataset.index;
          comments[index].likes += comments[index].isLiked ? -1 : +1;
          comments[index].isLiked = !comments[index].isLiked;

          renderComment();
        });
      }
    };

    //Цитата
    const initCommentListeners = () => {
      const commentButtons = document.querySelectorAll(".comment");
      for (const commentButton of commentButtons) {
        commentButton.addEventListener("click", () => {
          const index = commentButton.dataset.index;
          textInputElement.value = `${comments[index].name}:\n ${comments[index].text}`;
        });
      }
    };

    //Дата

    /* let currentDate = new Date();
    let zero = (n) => {
      return n < 10 ? `0${n}` : n;
    };

    const formDate = (currentDate) => {
      return `${zero(currentDate.getDate())}.${zero(
        currentDate.getMonth() + 1
      )}.${currentDate.getFullYear() % 100} ${zero(
        currentDate.getHours()
      )}:${zero(currentDate.getMinutes())}`;
      /*zero(currentDate.getDate()) + "." + zero(currentDate.getMonth() + 1) + "." + currentDate.getFullYear() % 100 + " " +
        zero(currentDate.getHours()) + ":" + zero(currentDate.getMinutes())
    }; */
 
    //Проверка, что поля ввода имени не пустые

    nameInputElement.addEventListener("input", () => {
      if (nameInputElement.value === "" || textInputElement.value === "") {
        addFormButtonElement.classList.add("empty");
        addFormButtonElement.disabled = true;
      } else if (
        nameInputElement.value !== "" &&
        textInputElement.value !== ""
      ) {
        addFormButtonElement.classList.remove("empty");
        addFormButtonElement.disabled = false;
      }
    });

    textInputElement.addEventListener("input", () => {
      if (textInputElement.value === "" || nameInputElement.value === "") {
        addFormButtonElement.classList.add("empty");
        addFormButtonElement.disabled = true;
      } else if (
        textInputElement.value !== "" &&
        nameInputElement.value !== ""
      ) {
        addFormButtonElement.classList.remove("empty");
        addFormButtonElement.disabled = false;
      }
    });
//Добавление нового комментария через API.(метод POST)
function postComments() {
      return fetch(urlApi, {
        method: "POST",
        body: JSON.stringify({
          name: nameInputElement.value,
          text: textInputElement.value,
          date: formatDateTime(new Date), 
          likes: 0,
          isLiked: false, 
        })
      }).then((response) => {
          return response.json();
        }).then((responseData) => {
          return getComments();
          console.log(comments);
          
        });
    };




    //Новый коментарий

    const addNewComment = () => {
      /* comments.push({
        name: nameInputElement.value
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("&", "&amp;")
          .replaceAll('"', "&quot;"),
        date: formatDateTime(new Date()),
        text: textInputElement.value
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("&", "&amp;")
          .replaceAll('"', "&quot;"),
        likes: 0,
        isLiked: false,
      }); */
      postComments();
      textInputElement.value = "";
      nameInputElement.value = "";
      renderComment();

    };

    addFormButtonElement.addEventListener("click", addNewComment);

    /*//Кнопка Enter
      form.addEventListener("keyup", (e) => {
        if (e.code === "Enter") addNewComment();
      });*/

    renderComment();
  </script>
</html>
